name: Build, Secrets, and Deploy to Pages

on:
  push:
    branches: [ main ] # или другая ветка, по которой запускается сборка

jobs:
  build-and-deploy: # Переименовал job для ясности
    runs-on: ubuntu-latest
    
    # Указываем среду, если она настроена в GitHub, иначе можно убрать
    # environment:
    #   name: github-pages
    #   url: ${{ steps.deployment.outputs.page_url }} # URL, куда будет развернут сайт

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # --- ШАГ 1: Обработка секретов (как у вас было) ---
      # ВАЖНО: Этот шаг ВСЕ ЕЩЕ ОПАСЕН для клиентского кода!
      # Если aiChat.js и laboratory.js запускаются в браузере, токен будет виден.
      # Если эти файлы серверные, то здесь все ОК.
      - name: Inject Secrets into JS files (DANGEROUS FOR CLIENT-SIDE JS!)
        run: |
          # Проверяем, существует ли секрет
          if [ -z "${{ secrets.GEN_API_API_KEY }}" ]; then
            echo "Error: GEN_API_API_KEY secret is not set."
            exit 1
          fi
          # Заменяем плейсхолдеры
          sed -i 's|__GEN_API_API_KEY__|${{ secrets.GEN_API_API_KEY }}|g' ./ai/aiChat.js
          sed -i 's|__GEN_API_API_KEY__|${{ secrets.GEN_API_API_KEY }}|g' ./laboratory/laboratory.js

      # --- ШАГ 2: Настройка Node.js ---
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20' # Используйте актуальную версию Node.js
          # Если ваш проект использует yarn:
          # packageManager: yarn@latest

      # --- ШАГ 3: Установка зависимостей ---
      - name: Install dependencies
        run: npm install
        # Если ваш проект использует yarn:
        # run: yarn install

      # --- ШАГ 4: Сборка проекта ---
      # Эта команда должна собрать ваш сайт в папку 'dist' или 'build'
      - name: Build project
        run: npm run build
        # Если ваш проект использует yarn:
        # run: yarn build
        # Убедитесь, что в вашем package.json есть скрипт "build", который создает нужную папку (например, dist)

      # --- ШАГ 5: Загрузка артефактов для GitHub Pages ---
      # Эта экшн берет содержимое папки 'dist' (или 'build') и готовит его к развертыванию
      - name: Upload artifact for GitHub Pages
        uses: actions/upload-pages-artifact@v3
        with:
          # Укажите путь к папке, которую создал ваш скрипт сборки
          # Чаще всего это 'dist' или 'build'. Проверьте вывод вашего npm run build!
          path: './dist' 

      # --- ШАГ 6: Развертывание на GitHub Pages ---
      # Эта экшн берет загруженные артефакты и публикует их на GitHub Pages
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
